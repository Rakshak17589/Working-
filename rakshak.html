<script type="module">

    // === GEMINI CONFIG ===
    const API_KEY = "YOUR_GEMINI_API_KEY";   // <-- ADD YOUR KEY HERE
    const MODEL = "gemini-2.5-flash";        // Stable model
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;

    // === DOM ELEMENTS ===
    const chatWindow = document.getElementById('chat-window');
    const userInput  = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const loadingIndicator = document.getElementById('loading-indicator');

    // Chat history
    let chatHistory = [];

    // === APPEND MESSAGES ===
    function appendMessage(sender, text) {
        const isUser = sender === "user";
        const wrapper = document.createElement("div");
        wrapper.className = `flex ${isUser ? "justify-end" : "justify-start"}`;

        const bubble = document.createElement("div");
        bubble.className =
            `max-w-xs md:max-w-sm p-3 shadow-md 
             ${isUser 
                ? "bg-indigo-600 text-white rounded-tl-xl rounded-tr-xl rounded-bl-xl" 
                : "bg-gray-100 text-gray-800 rounded-tr-xl rounded-bl-xl rounded-br-xl"
            }`;

        bubble.innerHTML = `
            <p class="font-bold ${isUser ? "text-white" : "text-indigo-600"} mb-1">
                ${isUser ? "You" : "Rakshak AI"}
            </p>
            <p>${text.replace(/\n/g, "<br>")}</p>
        `;

        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // === SEND REQUEST TO GEMINI ===
    async function fetchGeminiResponse(query) {
        const payload = {
            contents: [
                ...chatHistory,
                {
                    role: "user",
                    parts: [{ text: query }]
                }
            ]
        };

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            return (
                data?.candidates?.[0]?.content?.parts?.[0]?.text ||
                "I couldn't understand. Please try again."
            );

        } catch (err) {
            return "Connection error. Please try again.";
        }
    }

    // === SEND HANDLER ===
    async function handleSend() {
        const query = userInput.value.trim();
        if (!query) return;

        // UI: show your message
        appendMessage("user", query);
        userInput.value = "";
        userInput.disabled = true;
        sendButton.disabled = true;
        loadingIndicator.classList.remove("hidden");

        // Add to history
        chatHistory.push({ role: "user", parts: [{ text: query }] });

        // Get AI response
        const aiText = await fetchGeminiResponse(query);

        // Show AI message
        appendMessage("model", aiText);

        // Add to history
        chatHistory.push({ role: "model", parts: [{ text: aiText }] });

        // Re-enable UI
        userInput.disabled = false;
        sendButton.disabled = false;
        loadingIndicator.classList.add("hidden");
        userInput.focus();
    }

    // === EVENT LISTENERS ===
    sendButton.addEventListener("click", handleSend);

    userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            handleSend();
        }
    });

    userInput.addEventListener("input", () => {
        sendButton.disabled = !userInput.value.trim();
    });

    // Enable send button initially
    sendButton.disabled = false;

        </script>
